import os.path
import sys
import pefile
import magic
import re
import time
import json
import requests
from oletools.olevba import VBA_Parser, TYPE_OLE, TYPE_OpenXML, TYPE_Word2003_XML, TYPE_MHTML

DOC = ["application/msword", "application/vnd.ms-word.document.macroEnabled.12", "application/vnd.ms-word.template.macroEnabled.12"]
XLS = ["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", "application/vnd.ms-excel", "application/vnd.ms-excel.sheet.macroEnabled.12", "application/vnd.ms-excel.template.macroEnabled.12", "application/vnd.ms-excel.addin.macroEnabled.12", "application/vnd.ms-excel.sheet.binary.macroEnabled.12"]
PPT = ["application/vnd.ms-powerpoint", "application/vnd.ms-powerpoint.presentation.macroEnabled.12", "application/vnd.ms-powerpoint.template.macroEnabled.12", "application/vnd.ms-powerpoint.addin.macroEnabled.12", "application/vnd.ms-powerpoint.slideshow.macroEnabled.12"]
PDF = ["application/pdf"]
EXE = ["application/vnd.microsoft.portable-executable", "application/octet-stream", "application/x-dosexec"]

class Analysis:
    file = None
    mimeType = None
    artifacts = None
    verdict = None
    fileType = None
    decodeStrings = None
    virusTotalAPIKey = None
    virusTotalResults = None

    def __init__(self, file):
        self.file = file

    def doAnalysis(self):
        # If file is an office document, do this analysis
        if self.fileType == "office":
            # Use OLEVBA.VBA_Parser to parse VBA
            vbaparser = VBA_Parser(self.file)
            # Set IOC attribute to results of VBA parsing
            self.decodeStrings = True
            self.artifacts = vbaparser.analyze_macros(self.decodeStrings)
            # Close parser
            vbaparser.close()


        # If file is a pefile, do this analysis
        elif self.fileType == "exe":
            pe = pefile.PE(self.file)
            exeData = []
            for entry in pe.DIRECTORY_ENTRY_IMPORT:
                dllName = entry.dll
                functions = []
                for function in entry.imports:
                    functions.append(function.name)
                exeData.append([dllName, functions])
            # Maybe add a json format here before setting artifacts attribute.
            self.artifacts = exeData

    def getMimeType(self):
        mime = magic.Magic(mime=True)
        self.mimeType = mime.from_file(self.file)


    def getVerdict(self):
        vTotal = VirusTotalAPI(self.virusTotalAPIKey)
        vTotal.submitFile(self.file)
        self.virusTotalResults = vTotal.getReport()
        # Get VirusTotal Detection Rate

class VirusTotalAPI:

    host = None
    apiKey = None
    scanID = None
    reportResponseCode = None

    def __init__(self, apiKey):
        self.host = "https://www.virustotal.com/vtapi/v2/"
        self.apiKey = apiKey

    def submitFile(self, file):
        # Generate VirusTotal Report - Submit File
        url = self.host + "file/scan"
        readFile = open(file, 'rb')
        parameters = {"apikey":self.apiKey}
        req = requests.post(url, data=parameters, files={'file':readFile})
        response = req.json()
        readFile.close()
        self.scanID = response["scan_id"]

    def getReport(self):
        # Retrive VirusTotal Report
        url = self.host + "file/report"
        parameters = {"apikey":self.apiKey, "resource":self.scanID}
        heads = {"Accept-Encoding": "gzip, deflate", "User-Agent" : "gzip, Python Request"}
        response = ""
        while True:
            req = requests.get(url, params=parameters, headers=heads)
            response = req.json()
            self.reportResponseCode = response["response_code"]
            print self.reportResponseCode
            if self.reportResponseCode == 1:
                break
            print "File is not done being analyzed, trying again in 10 seconds"
            time.sleep(10)

        return response

def main():
    start = time.time()

    # Init fileAnalysis object with passed file
    fileAnalysis = Analysis(sys.argv[1])
    # Get VirusTotalAPI Key passed as command line argument
    fileAnalysis.virusTotalAPIKey = sys.argv[2]
    # Set mimeType attribute
    fileAnalysis.getMimeType()

    # Check if mimeType attribute is accepted file type
    if (fileAnalysis.mimeType in DOC) or (fileAnalysis.mimeType in XLS) or (fileAnalysis.mimeType in PPT):
        print "This is a Microsoft Office Document"
        fileAnalysis.fileType = "office"
        fileAnalysis.doAnalysis()
        fileAnalysis.getVerdict()

        print fileAnalysis.virusTotalResults

        #for kw_type, keyword, description in fileAnalysis.artifacts:
            #print 'type=%s - keyword=%s - description=%s' % (kw_type, keyword, description)
    elif fileAnalysis.mimeType in PDF:
        print "This is a PDF file"
    elif fileAnalysis.mimeType in EXE:
        print "This is a EXE file"
        fileAnalysis.fileType = "exe"
        fileAnalysis.doAnalysis()
        fileAnalysis.getVerdict()

        print fileAnalysis.virusTotalResults

    elif re.match(r"^image\/\w*$", fileAnalysis.mimeType):
        print "This is a image file"
    else:
        print "This file is not supported at this time"

    end = time.time()

    print(end - start)

main()
